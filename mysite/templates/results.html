<!doctype html>
<html>

<head>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
    integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js"
    integrity="sha512-RXf+QSDCUQs5uwRKaDoXt55jygZZm2V++WUZduaU/Ui/9EGp3f/2KZVahFZBKGH0s774sd3HmrhUy+SgOFQLVQ=="
    crossorigin="anonymous"></script>
  <title>Degree Of Representativeness</title>
  <meta name="description" content="Online tool that computes the degree of representativeness (psi), . . .">
  <link href="{{ url_for('static', filename='css/reprdeg.css') }}" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/camanjs/4.1.2/caman.full.min.js" integrity="sha512-JjFeUD2H//RHt+DjVf1BTuy1X5ZPtMl0svQ3RopX641DWoSilJ89LsFGq4Sw/6BSBfULqUW/CfnVopV5CfvRXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>


<body class="text-center">
    <a href="#eng" onclick="load_language('eng')">English</a>
    |
    <a href="#ita" onclick="load_language('ita')">Italiano</a>
    <h1 id="title"></h1>
    <p id="scope" class="h5 mb-4"></p>
    <div class="results">
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a href="#home" class="nav-link active" role="tab" data-toggle="tab" id="first_page"></a>
            </li>
            <li class="nav-item">
                <a href="#plot_dataset1" class="nav-link" role="tab" data-toggle="tab" id="second_page"></a>
            </li>
        </ul>
        <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="home">
                <div class="text-center informative">
                    <p class="h4"><b>Result (PSI): {{pvalue}}</p></b>
                    <p id="method_used" class="h6 font-italic"></p>
                    <div id="container" class="img-comp-container mb-4">
                        <div class="img-comp-img">
                            <img id="img_original" src="{{ url_for('static', filename='img/canvas_100.png')}}">
                        </div>
                        <div class="img-comp-img img-comp-overlay">
                            <img id="img_grainy" src="{{ url_for('static', filename='img/canvas_100.png')}}">
                        </div>
                    </div>
                    <div class="container mb-4 ">
                        <div class="row">
                            <div class="col-sm">
                                <div class="card">
                                    <img class="card-img-top" src="{{ url_for('static', filename='img/canvas_100.png') }}" alt="Card image cap">
                                    <div class="card-body">
                                        <h5 class="card-title">PSI = 100%</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm">
                                <div class="card">
                                    <img class="card-img-top" src="{{ url_for('static', filename='img/canvas_75.png') }}" alt="Card image cap">
                                    <div class="card-body">
                                        <h5 class="card-title">PSI = 75%</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm">
                                <div class="card">
                                    <img class="card-img-top" src="{{ url_for('static', filename='img/canvas_50.png') }}" alt="Card image cap">
                                    <div class="card-body">
                                        <h5 class="card-title">PSI = 50%</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm">
                                <div class="card">
                                    <img class="card-img-top" src="{{ url_for('static', filename='img/canvas_25.png') }}" alt="Card image cap">
                                    <div class="card-body">
                                        <h5 class="card-title">PSI = 25%</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm">
                                <div class="card">
                                    <img class="card-img-top" src="{{ url_for('static', filename='img/canvas_0.png') }}" alt="Card image cap">
                                    <div class="card-body">
                                        <h5 class="card-title">PSI = 0%</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <a href="#" data-bs-toggle="modal" data-toggle="modal" data-target="#myModal" id="help"></a><i class="fas fa-eye"></i>
                </div>
            </div>
            <div role="tabpanel" class="tab-pane container" id="plot_dataset1">
                <div class="row">
                    <img src="data:image/jpg;base64, {{plot_dataset1a}}" class="rotate-image col col-md">
                    <fieldset style="display: inline-block;">
                        <legend>Dataset:</legend>
                            <p>
                                <div style="display: inline; color:#1f77b4" class="fa fa-square"></div>
                                <p style="display: inline">{{dataset_name_set1}}</p>
                            </p>
                            <p>
                                <div style="display: inline; color:#ff7f0e" class="fa fa-square"></div>
                                <p style="display: inline">{{dataset_name_set2}}</p>
                            </p>
                    </fieldset>
                    <img src="data:image/jpg;base64, {{plot_dataset1b}}" class="img-plot1 col col-md">
                </div>
                <div class="text-center informative">
                    <a href="#" data-bs-toggle="modal" data-toggle="modal" data-target="#myModal2" id="help2"></a><i class="fas fa-eye"></i>
                </div>
            </div>
        </div>
            <button type="button" onclick="window.location.href = '{{url_for('home')}}';" class="btn-lg btn-primary" style="margin-top: 25px;">
                <div style="display: inline" class="fas fa-arrow-left"></div>
                <div id="back_home" style="display: inline"></div>
            </button>
            <p class="mt-5 mb-3 text-muted text-center">Project developed at MUDI Lab by Jury Andrea D'Onofrio <a href="https://github.com/JuryAndreaDonofrio">https://github.com/JuryAndreaDonofrio</a>. For more details on this score please refer to:
            Cabitza, F., Campagner, A., Sconfienza, L.M., As if sand were stone. New concepts and metrics to probe the ground
            on which to build trustable AI. BMC Medical Informatics and DecisionMaking. <a href="https://doi.org/10.1186/s12911-020-01224-9">https://doi.org/10.1186/s12911-020-01224-9</a>
            </p>
    </div>

  <!-- The Modal -->
  <div class="modal" id="myModal">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">

        <!-- Modal Header -->
        <div class="modal-header">
          <h4 id="title_modal" class="modal-title"></h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <!-- Modal body -->
        <div class="modal-body">
          <p id="interpretation"></p>
        </div>

        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="myModal2">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">

        <!-- Modal Header -->
        <div class="modal-header">
          <h4 id="title_modal2" class="modal-title"></h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <!-- Modal body -->
        <div class="modal-body">
          <p id="interpretation2"></p>
        </div>

        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>



  <script>
    function set_cookie(cname, cvalue, exdays) {
        const d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        let expires = "expires="+d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    function get_cookie(cname){
        let name = cname + "=";
        let ca = document.cookie.split(';');
        for(let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }
  </script>

  <script>
    var language = {
      eng:{
        title: "Degree Of Correspondence (PSI)",
        scope: "Online tool that computes the degree of correspondence (psi), or similarity between two datasets",
        method_used: "Test method used: Kolmogorov-Smirnov with 200 iterations",
        help: "Show me the interpretation of the score ",
        help2: "Show me the interpretation of the score ",
        title_modal: "Interpretation of the score",
        title_modal2: "Interpretation of the score",
        interpretation: "This visualization renders (in visual terms) the extent a dataset (or data point) is similar to (or representative of) a reference dataset. The lower the score, the more grainy the image, the fewer details can be noticed wrt to the original image, and the less similar the two datasets are (or the less representative the smaller sample is wrt the larger one from which this has been drawn out). Practically speaking, the predictions made by a predictive/classification model on data points that are (taken from a dataset that is) little representative of the model's training set should be taken with great caution and considered potentially unreliable. Conversely, if a test set is found to be little (or not at all) representative of the bigger training set, and the performance of a predictive model tested on this former set is good or acceptable, then the model could be considered of sufficient reliability and robustness. On a very qualitative level, if you cannot detect picture elements like the cross in front of you or the american flag, then you are dealing with a highly different dataset. If you cannot detect the biggest billboards or the silhouette of the skyscraper building in the middle of the picture, then your dataset is almost totally different from the other dataset. This is a qualitative assessment!",
        interpretation2: "On the left, scatter plot of the 2 most important features calculated with the SelectKBest method and the mutual_info_classif metric; each data point is a case/instance in each dataset. On the right, the diagrams of the density and the cumulative distribution function of the first principal component of the union set of the datasets. Data are standardized.",
        back_home: "Back Home",
        first_page: "Home",
        second_page: "Diagrams"
      },
      ita:{
        title: "Grado di Corrispondenza (PSI)",
        scope: "Strumento online che calcola il grado di corrispondenza (psi), o di similarità tra due dataset",
        method_used: "Test usato: Kolmogorov-Smirnov con 200 iterations",
        help: "Mostrami l'interpretazione del risultato ",
        help2: "Mostrami l'interpretazione del risultato ",
        title_modal: "Interpretazione del risultato",
        title_modal2: "Interpretazione del risultato",
        interpretation: "Questa visualizzazione rappresenta (in termini visivi) la misura in cui un dataset (o un data point) è simile a (o rappresentativo di) un dataset di riferimento. Più basso è il punteggio, più sgranata è l'immagine, meno dettagli si notano rispetto all'immagine originale e meno simili sono i due dataset (o meno rappresentativo è il campione più piccolo rispetto a quello più grande da cui è stato estratto). In pratica, le previsioni fatte da un modello predittivo/classificativo su data points che sono (presi da un dataset cioè) poco rappresentativi del training set del modello, dovrebbero essere prese con grande cautela e considerate potenzialmente inaffidabili. Al contrario, se un test set risulta poco (o per niente) rappresentativo del training set più grande e le prestazioni di un modello predittivo testato su questo set precedente sono buone o accettabili, allora il modello potrebbe essere considerato di sufficiente affidabilità e robustezza. A un livello molto qualitativo, se non riesci a rilevare elementi dell'immagine come la croce davanti a te o la bandiera americana, allora hai a che fare con un dataset molto diverso. Se non riesci a rilevare i cartelloni pubblicitari più grandi o la sagoma del grattacielo al centro dell'immagine, il tuo dataset è quasi totalmente diverso dall'altro. Questa è una valutazione qualitativa!",
        interpretation2: "A sinistra, un grafico a dispersione delle 2 caratteristiche più importanti calcolate con il metodo SelectKBest e la metrica mutual_info_classif; ogni punto è un caso/istanza in ogni set di dati. A destra, i diagrammi della densità e della funzione di distribuzione cumulativa del primo componente principale dell'unione dei dataset. I dati sono standardizzati.",
        back_home: "Torna indietro",
        first_page: "Home",
        second_page: "Diagrammi"
      }
    }

    function load_language(l = "eng") {
        if(typeof language[l] === "undefined"){
            l="eng";
        }
        set_cookie("language", l, 30);
        for (const key in language[l]) {
            document.getElementById(key).innerHTML = language[l][key];
        }
    }
    var cookie_language = get_cookie("language");
    load_language(cookie_language);
  </script>

  <script>
    TurnInCanvas(document.getElementById("img_grainy"))
    function TurnInCanvas(obj) {
        Caman(obj, function() {
            this.render();
            SwapPixel({{pvalue_percent}}, "img_grainy");
            $("#img_grainy").height($("#img_original").height());
            $("#container").height($("#img_original").height());
            $( window ).resize(function() {
                $("#img_grainy").height($("#img_original").height());
                $("#container").height($("#img_original").height());
            });
            initComparisons();
        });
    }

    function SwapPixel(n, id) {
        n = 100 - n;

        let img = document.getElementById(id);

        let canvasWidth = img.width;
        let canvasHeight = img.height;

        let ctx = img.getContext('2d');
        let imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);

        //importo i dati salvati per riapplicare la funzione dall'inizio
        let data = imageData.data;

        //faccio passare un pixel alla volta
        for (let y = 0; y < canvasHeight; y++) {
            for (let x = 0; x < canvasWidth; x++) {
                let index = (y * canvasWidth + x) * 4;
                let index2 = Math.round(Math.random() * canvasWidth * canvasHeight) * 4;
                //console.log('SwapIteration');
                if ((Math.random() * 100) < n) {
                    //scambio i pixel
						[data[index], data[index2]] = [data[index2], data[index]];
						[data[index + 1], data[index2 + 1]] = [data[index2 + 1], data[index + 1]];
						[data[index + 2], data[index2 + 2]] = [data[index2 + 2], data[index + 2]];
                }
            }
        }
        ctx.putImageData(imageData, 0, 0);
    }
  </script>

  <script>
    function initComparisons() {
        var x, i;
        /*find all elements with an "overlay" class:*/
        x = document.getElementsByClassName("img-comp-overlay");
        for (i = 0; i < x.length; i++) {
            /*once for each "overlay" element:
            pass the "overlay" element as a parameter when executing the compareImages function:*/
            compareImages(x[i]);
        }
        function compareImages(img) {
            var slider, img, clicked = 0, w, h;
                w = img.offsetWidth;
                h = img.offsetHeight;
                img.style.width = (w / 2) + "px";
                slider = document.createElement("DIV");
                slider.setAttribute("class", "img-comp-slider");
                img.parentElement.insertBefore(slider, img);
                slider.style.top = (h / 2) - (slider.offsetHeight / 2) + "px";
                slider.style.left = (w / 2) - (slider.offsetWidth / 2) + "px";
                slider.addEventListener("mousedown", slideReady);
                window.addEventListener("mouseup", slideFinish);
                slider.addEventListener("touchstart", slideReady);
                window.addEventListener("touchend", slideFinish);
            $( window ).resize(function() {
                img.style.width = "100%";
                w = img.offsetWidth;
                h = img.offsetHeight;
                img.style.width = (w / 2) + "px";

                slider.style.top = (h / 2) - (slider.offsetHeight / 2) + "px";
                slider.style.left = (w / 2) - (slider.offsetWidth / 2) + "px";
            });

            function slideReady(e) {
                /*prevent any other actions that may occur when moving over the image:*/
                e.preventDefault();
                /*the slider is now clicked and ready to move:*/
                clicked = 1;
                /*execute a function when the slider is moved:*/
                window.addEventListener("mousemove", slideMove);
                window.addEventListener("touchmove", slideMove);
            }
            function slideFinish() {
                /*the slider is no longer clicked:*/
                clicked = 0;
            }
            function slideMove(e) {
                var pos;
                /*if the slider is no longer clicked, exit this function:*/
                if (clicked == 0) return false;
                /*get the cursor's x position:*/
                pos = getCursorPos(e)
                /*prevent the slider from being positioned outside the image:*/
                if (pos < 0) pos = 0;
                if (pos > w) pos = w;
                /*execute a function that will resize the overlay image according to the cursor:*/
                slide(pos);
            }
            function getCursorPos(e) {
                var a, x = 0;
                e = e || window.event;
                /*get the x positions of the image:*/
                a = img.getBoundingClientRect();
                /*calculate the cursor's x coordinate, relative to the image:*/
                x = e.pageX - a.left;
                /*consider any page scrolling:*/
                x = x - window.pageXOffset;
            return x;
            }
            function slide(x) {
                /*resize the image:*/
                img.style.width = x + "px";
                /*position the slider:*/
                slider.style.left = img.offsetWidth - (slider.offsetWidth / 2) + "px";
            }
        }
    }
</script>
</body>